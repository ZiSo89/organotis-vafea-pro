name: Update Deploy from Develop

# Î‘Ï…Ï„ÏŒ Ï„Î¿ workflow Ï„ÏÎ­Ï‡ÎµÎ¹ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± (manually) ÏŒÏ„Î±Î½ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÎ¹Ï‚ Ï„Î¿ deploy
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to confirm deploy update'
        required: true
        default: 'no'

jobs:
  update-deploy:
    name: Merge develop â†’ deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm != 'yes' }}
        run: |
          echo "âŒ Deployment not confirmed. Exiting."
          exit 1
      
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
      - name: Checkout deploy branch
        run: git checkout deploy
      
      - name: Merge develop into deploy
        run: |
          git merge origin/develop --no-ff -m "Auto-merge develop into deploy (GitHub Actions)"
      
      - name: Remove development-only files
        run: |
          # Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï†Î±ÎºÎ­Î»Ï‰Î½ Ï€Î¿Ï… Î´ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ ÏƒÎµ production
          git rm -r --ignore-unmatch database electron tools dist node_modules
          git rm --ignore-unmatch router.php package.json package-lock.json .htaccess.production
          
          # Commit Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î»Î»Î±Î³Î­Ï‚
          if ! git diff --cached --quiet; then
            git commit -m "Clean deploy: remove development files"
          fi
      
      - name: Push to deploy branch
        run: git push origin deploy
      
      - name: Summary
        run: |
          echo "âœ… Deploy branch updated successfully!"
          echo "ğŸ“¦ Production files: api/, config/, public/"
          echo "ğŸš€ Plesk will auto-deploy (if enabled)"

# Î ÏÏ‚ Î½Î± Ï„Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚:
# 1. Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î¿ GitHub â†’ Actions â†’ "Update Deploy from Develop"
# 2. ÎšÎ¬Î½Îµ "Run workflow"
# 3. Î“ÏÎ¬ÏˆÎµ "yes" ÏƒÏ„Î¿ confirmation field
# 4. Î¤Î¿ workflow Î¸Î± ÎºÎ¬Î½ÎµÎ¹ merge develop â†’ deploy ÎºÎ±Î¹ Î¸Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ dev files
